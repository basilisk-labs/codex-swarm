<!doctype html>
<html lang="en" data-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Local task viewer with kanban and table views." />
  <meta name="application-name" content="Codex Swarm Tasks" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#f2f2f7" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)" />
  <meta property="og:title" content="Codex Swarm Tasks" />
  <meta property="og:description" content="Local task viewer with kanban and table views." />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Codex Swarm" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Codex Swarm Tasks" />
  <meta name="twitter:description" content="Local task viewer with kanban and table views." />
  <title>Codex Swarm - Tasks</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap");

    :root {
      color-scheme: dark;

      /* Cyberpuk Layout */
      --sidebar-width: 70px;

      /* Cyberpunk Palette */
      --bg: #050505;
      --bg-2: #0a0a0a;
      --panel: rgba(10, 15, 20, 0.9);
      --panel-2: rgba(20, 25, 30, 0.7);

      --text: #e0f0ff;
      --text-dim: #708090;
      --muted: #4a5a6a;

      --border: #334455;
      --border-active: #00f0ff;

      --shadow: rgba(0, 240, 255, 0.1);

      /* Neon Accents */
      --accent: #00f0ff;
      /* Cyan */
      --accent-2: #ff0055;
      /* Hot Pink */
      --accent-3: #f0ff00;
      /* Yellow/Lime */
      --accent-4: #00ff41;
      /* Matrix Green */

      --good: #00ff41;
      --warn: #ffbd00;
      --bad: #ff003c;

      --chip-bg: rgba(0, 240, 255, 0.1);
      --chip-border: rgba(0, 240, 255, 0.4);

      /* Fonts */
      --mono: "Share Tech Mono", monospace;
      --sans: "Share Tech Mono", monospace;
      --display: "VT323", monospace;

      --column-gap: 20px;
      --card-gap: 16px;
    }

    * {
      box-sizing: border-box;
    }

    html {
      min-height: 100%;
    }

    /* CRT Scanline Effect */
    body {
      margin: 0;
      font-family: var(--sans);
      background-color: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      /* Main scroll is inside content area */
      position: relative;
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.15;
    }

    /* Grid Background */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.08;
      pointer-events: none;
      z-index: 0;
      mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      text-shadow: 0 0 8px var(--accent);
    }

    /* SCROLLBARS */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-2);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* SIDEBAR */
    .sidebar {
      background: rgba(5, 8, 10, 0.95);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 50;
      padding: 10px 0;
      align-items: center;
    }

    .sidebar-header {
      padding: 12px 8px 16px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
      text-align: center;
    }

    .logo-text {
      font-family: var(--display);
      font-size: 11px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      line-height: 1.3;
      text-shadow: 0 0 5px rgba(0, 240, 255, 0.5);
    }

    .logo-sub {
      display: none;
    }

    .nav-menu {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 0 8px;
      flex: 1;
      width: 100%;
    }

    .nav-item {
      width: 54px;
      height: 54px;
      padding: 0;
      color: var(--text-dim);
      font-size: 9px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s;
      border: 1px solid transparent;
      background: rgba(0, 0, 0, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
    }

    .nav-item:hover {
      color: var(--text);
      background: rgba(0, 240, 255, 0.08);
      border-color: var(--border);
    }

    .nav-item.active {
      color: var(--accent);
      background: rgba(0, 240, 255, 0.12);
      border-color: var(--accent);
      text-shadow: 0 0 5px rgba(0, 240, 255, 0.5);
      box-shadow: 0 0 12px rgba(0, 240, 255, 0.2), inset 0 0 8px rgba(0, 240, 255, 0.1);
    }

    .nav-item.active::before {
      content: "";
      position: absolute;
      left: -9px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 30px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
      opacity: 0.9;
    }

    .nav-item span {
      font-size: 8px;
      opacity: 0.8;
    }

    .sidebar-footer {
      padding: 10px 8px;
      border-top: 1px solid var(--border);
      font-size: 8px;
      color: var(--muted);
      text-align: center;
    }

    /* MAIN CONTENT AREA */
    .main {
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
      position: relative;
    }

    /* HEADER DESK */
    .control-deck {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(5, 10, 15, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      z-index: 40;
    }

    .view-title {
      font-family: var(--display);
      font-size: 24px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .view-title::before {
      content: "//";
      color: var(--accent-2);
      opacity: 0.7;
    }

    .deck-actions {
      display: flex;
      gap: 12px;
    }

    /* SCROLLABLE VIEWPORT */
    .viewport {
      overflow-y: auto;
      padding: 24px;
      position: relative;
    }

    .tab-content {
      display: none;
      animation: fade-in 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* DASHBOARD WIDGETS */

    /* PANEL / CONTROLS */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
    }

    /* Corner accents for panels */
    .panel::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 8px;
      height: 8px;
      border-top: 2px solid var(--accent);
      border-left: 2px solid var(--accent);
    }

    .panel::after {
      content: "";
      position: absolute;
      bottom: 0;
      right: 0;
      width: 8px;
      height: 8px;
      border-bottom: 2px solid var(--accent);
      border-right: 2px solid var(--accent);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: minmax(200px, 1.5fr) repeat(auto-fit, minmax(140px, 1fr));
      gap: 20px;
      align-items: end;
      padding: 20px;
    }

    label {
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 6px;
      display: block;
      opacity: 0.8;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
      border-left: 2px solid var(--border);
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      border-left-width: 4px;
      background: rgba(0, 240, 255, 0.05);
    }

    /* BUTTONS */
    .btn {
      background: rgba(0, 240, 255, 0.08);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      color: var(--text);
      padding: 8px 16px;
      font-family: var(--mono);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .btn:hover {
      background: rgba(0, 240, 255, 0.15);
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 4px 12px rgba(0, 240, 255, 0.2);
    }

    .btn-primary {
      background: rgba(0, 240, 255, 0.2);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* KANBAN BOARD */
    .board {
      display: grid;
      grid-template-columns: repeat(4, minmax(300px, 1fr));
      gap: var(--column-gap);
      overflow-x: auto;
      padding-bottom: 20px;
      align-items: start;
    }

    .column {
      display: grid;
      gap: 16px;
    }

    .column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }

    .column-title {
      font-family: var(--display);
      font-size: 18px;
      text-transform: uppercase;
      color: var(--text);
      letter-spacing: 1px;
    }

    .column[data-status="TODO"] .column-title {
      color: var(--muted);
    }

    .column[data-status="DOING"] .column-title {
      color: var(--accent);
    }

    .column[data-status="BLOCKED"] .column-title {
      color: var(--bad);
    }

    .column[data-status="DONE"] .column-title {
      color: var(--good);
    }

    /* CARDS */
    .card {
      background: rgba(15, 20, 25, 0.95);
      border: 1px solid var(--border);
      border-left: 4px solid var(--muted);
      padding: 16px;
      display: grid;
      gap: 10px;
      cursor: grab;
      position: relative;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: var(--border-active);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 240, 255, 0.1);
      z-index: 2;
    }

    .card[data-status="todo"] {
      border-left-color: var(--muted);
      background: rgba(74, 90, 106, 0.1);
    }

    .card[data-status="doing"] {
      border-left-color: var(--accent);
      background: rgba(0, 240, 255, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 10px rgba(0, 240, 255, 0.15);
    }

    .card[data-status="blocked"] {
      border-left-color: var(--bad);
      background: rgba(255, 0, 60, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), 0 0 10px rgba(255, 0, 60, 0.15);
    }

    .card[data-status="done"] {
      border-left-color: var(--good);
      background: rgba(0, 255, 65, 0.05);
    }

    .card-title {
      font-size: 15px;
      font-family: var(--display);
      letter-spacing: 0.5px;
      line-height: 1.2;
      color: var(--text);
      margin-left: 8px;
    }

    .card-meta,
    .card-tags,
    .card-desc {
      margin-left: 8px;
      font-size: 12px;
    }

    .card-meta {
      color: var(--text-dim);
    }

    .card-desc {
      color: var(--muted);
      border-left: 1px solid var(--border);
      padding-left: 8px;
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border: 1px solid var(--border);
      color: var(--accent-3);
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.3);
    }

    /* AGENT GRID */
    .agent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .agent-card {
      background: rgba(255, 0, 85, 0.08);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent-2);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
      transition: all 0.2s;
    }

    .agent-card:hover {
      box-shadow: 0 4px 16px rgba(255, 0, 85, 0.2);
      border-color: var(--accent-2);
    }

    .agent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .agent-id {
      font-family: var(--display);
      font-size: 20px;
      color: var(--accent-2);
      letter-spacing: 1px;
    }

    .agent-role {
      font-size: 12px;
      color: var(--text);
      font-weight: bold;
    }

    .agent-desc {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.4;
      flex: 1;
    }

    .agent-meta {
      margin-top: auto;
      display: grid;
      gap: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    /* SYSTEM VIEW */
    .system-stats {
      display: grid;
      gap: 20px;
    }

    .stat-row {
      background: rgba(0, 240, 255, 0.06);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .stat-label {
      color: var(--accent);
      font-size: 12px;
      text-transform: uppercase;
    }

    .stat-val {
      color: var(--text);
      font-family: var(--display);
      font-size: 18px;
    }

    /* DRAWER */
    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(500px, 90vw);
      background: rgba(5, 8, 10, 0.98);
      border-left: 2px solid var(--border-active);
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.2, 1, 0.3, 1);
      z-index: 100;
      box-shadow: -100px 0 100px rgba(0, 0, 0, 0.8);
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 24px;
      background: rgba(0, 240, 255, 0.05);
      border-bottom: 1px solid var(--border);
    }

    .drawer-title {
      font-family: var(--display);
      font-size: 24px;
      color: var(--accent);
    }

    .drawer-body {
      padding: 24px;
      overflow-y: auto;
      display: grid;
      gap: 24px;
    }

    .drawer-section {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      padding: 16px;
      position: relative;
    }

    .drawer-section::before {
      content: "Datastream";
      position: absolute;
      top: -7px;
      right: 10px;
      background: var(--bg);
      padding: 0 6px;
      font-size: 9px;
      color: var(--muted);
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid currentColor;
      text-transform: uppercase;
    }

    .status-badge.status-todo {
      color: var(--muted);
    }

    .status-badge.status-doing {
      color: var(--accent);
      text-shadow: 0 0 5px var(--accent);
    }

    .status-badge.status-blocked {
      color: var(--bad);
      text-shadow: 0 0 5px var(--bad);
    }

    .status-badge.status-done {
      color: var(--good);
      text-shadow: 0 0 5px var(--good);
    }


    html[data-theme="dark"] {
      --bg: #000000;
      --bg-2: #0c0c0d;
      --panel: #1c1c1e;
      --panel-2: #2c2c2e;
      --text: #f2f2f7;
      --muted: #8e8e93;
      --border: rgba(84, 84, 88, 0.6);
      --shadow: rgba(0, 0, 0, 0.6);
      --chip-bg: rgba(0, 122, 255, 0.2);
      --chip-border: rgba(0, 122, 255, 0.34);
    }

    * {
      box-sizing: border-box;
    }

    html {
      min-height: 100%;
    }

    @keyframes fade-up {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes card-rise {
      from {
        opacity: 0;
        transform: translateY(12px) scale(0.98);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    body {
      margin: 0;
      font-family: var(--sans);
      background: linear-gradient(180deg, var(--bg), var(--bg-2));
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: -20% -10%;
      background:
        radial-gradient(600px 420px at 10% 0%, rgba(0, 122, 255, 0.16), transparent 65%),
        radial-gradient(520px 380px at 90% 10%, rgba(255, 159, 10, 0.14), transparent 60%),
        radial-gradient(640px 420px at 85% 85%, rgba(90, 200, 250, 0.16), transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
      background-size: 28px 28px;
      opacity: 0.12;
      pointer-events: none;
      z-index: 0;
    }

    html[data-theme="dark"] body::after {
      opacity: 0.06;
    }

    a {
      color: inherit;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 22px 64px;
      position: relative;
      z-index: 1;
    }

    header {
      display: grid;
      gap: 18px;
      margin-bottom: 22px;
      animation: fade-up 0.45s ease both;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .app-bar {
      position: sticky;
      top: 14px;
      z-index: 6;
      padding: 12px 14px;
      border-radius: 0;
      background: rgba(255, 255, 255, 0.86);
      border: 1px solid var(--border);
      backdrop-filter: blur(12px);
      box-shadow: 0 12px 24px var(--shadow);
      transition: padding 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      margin-bottom: 16px;
    }

    html[data-theme="dark"] .app-bar {
      background: rgba(28, 28, 30, 0.86);
    }

    .app-bar.compact {
      padding: 8px 12px;
      box-shadow: 0 16px 30px var(--shadow);
    }

    .app-bar.compact h1 {
      font-size: 20px;
    }

    .app-bar.compact .mark {
      transform: scale(0.85);
    }

    .app-bar.compact .meta-secondary {
      display: none;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .mark {
      width: 18px;
      height: 18px;
      border-radius: 0;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 0 6px rgba(0, 122, 255, 0.2);
      transition: transform 0.2s ease;
    }

    h1 {
      font-size: 24px;
      font-family: var(--display);
      margin: 0;
      letter-spacing: 0.2px;
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.02em;
    }

    .meta-secondary {
      font-size: 11px;
      margin-top: 4px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: 0 18px 38px var(--shadow);
    }

    .controls {
      padding: 18px 18px;
      display: grid;
      gap: 14px;
      animation: fade-up 0.5s ease both;
      animation-delay: 0.04s;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: minmax(240px, 1.2fr) repeat(5, minmax(140px, 1fr));
      gap: 14px;
    }

    @media (max-width: 1200px) {
      .controls-grid {
        grid-template-columns: repeat(3, minmax(160px, 1fr));
      }
    }

    @media (max-width: 760px) {
      .controls-grid {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: grid;
      gap: 8px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 11px 12px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      outline: none;
      font-family: var(--sans);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input[type="text"]::placeholder {
      color: var(--muted);
    }

    input[type="text"]:focus,
    select:focus {
      border-color: rgba(0, 122, 255, 0.55);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.12);
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 12px;
      border-radius: 0;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      color: var(--text);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }

    .chip[data-status] {
      cursor: pointer;
    }

    .chip[data-status]:hover {
      transform: translateY(-1px);
      border-color: rgba(0, 122, 255, 0.4);
    }

    .chip.active {
      background: rgba(0, 122, 255, 0.18);
      border-color: rgba(0, 122, 255, 0.36);
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 0;
    }

    .dot.todo {
      background: var(--muted);
    }

    .dot.doing {
      background: var(--accent);
    }

    .dot.blocked {
      background: var(--bad);
    }

    .dot.done {
      background: var(--good);
    }

    .actions {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 0;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      color: var(--text);
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: rgba(0, 122, 255, 0.4);
      background: linear-gradient(180deg, rgba(0, 122, 255, 0.08), rgba(0, 122, 255, 0.02));
      box-shadow: 0 10px 20px var(--shadow);
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.22), rgba(255, 159, 10, 0.16));
      border-color: rgba(0, 122, 255, 0.48);
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .order-toggle .order-icon {
      width: 16px;
      height: 16px;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.6;
      transition: transform 0.2s ease;
    }

    .order-toggle.reverse .order-icon {
      transform: rotate(180deg);
    }

    .order-toggle .btn-label {
      font-size: 12px;
      letter-spacing: 0.04em;
    }

    .board {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(4, minmax(280px, 1fr));
      gap: var(--column-gap);
      overflow-x: auto;
      padding-bottom: 12px;
      align-items: start;
      scroll-snap-type: x proximity;
      animation: fade-up 0.55s ease both;
      animation-delay: 0.08s;
    }

    @media (max-width: 1100px) {
      .board {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      .board {
        grid-template-columns: 1fr;
      }
    }

    .column {
      display: grid;
      gap: 14px;
      min-height: 200px;
      scroll-snap-align: start;
    }

    .column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .column-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .column-title::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 0;
      background: var(--muted);
    }

    .column[data-status="TODO"] .column-title::before {
      background: var(--muted);
    }

    .column[data-status="DOING"] .column-title::before {
      background: var(--accent);
    }

    .column[data-status="BLOCKED"] .column-title::before {
      background: var(--bad);
    }

    .column[data-status="DONE"] .column-title::before {
      background: var(--good);
    }

    .column-body {
      display: grid;
      gap: var(--card-gap);
      padding: 14px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel-2), var(--panel));
      min-height: 160px;
      transition: border-color 0.2s ease, background 0.2s ease;
      align-content: start;
    }

    .column-body.drag-over {
      border-color: rgba(0, 122, 255, 0.4);
      background: rgba(0, 122, 255, 0.08);
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 0;
      padding: 12px 12px 10px;
      display: grid;
      gap: 8px;
      cursor: grab;
      border-left: 3px solid transparent;
      box-shadow: 0 10px 20px var(--shadow);
      transition: transform 0.16s ease, border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
      animation: card-rise 0.35s ease both;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(0, 122, 255, 0.3);
      background: rgba(0, 122, 255, 0.05);
      box-shadow: 0 16px 28px var(--shadow);
    }

    .card:active {
      cursor: grabbing;
    }

    .card[data-status="todo"] {
      border-left-color: rgba(110, 110, 115, 0.7);
    }

    .card[data-status="doing"] {
      border-left-color: var(--accent);
    }

    .card[data-status="blocked"] {
      border-left-color: var(--bad);
    }

    .card[data-status="done"] {
      border-left-color: var(--good);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
    }

    .card-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--muted);
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 9px;
      border-radius: 0;
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      font-size: 10px;
      color: var(--muted);
      line-height: 1.2;
    }

    .tag-btn {
      cursor: pointer;
      background: var(--panel-2);
      color: var(--text);
    }

    .card-desc {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    .status-line {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 0;
      border: 1px solid var(--border);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .status-badge .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 0;
      background: currentColor;
    }

    .status-badge.status-todo {
      color: var(--muted);
      background: rgba(110, 110, 115, 0.18);
      border-color: rgba(110, 110, 115, 0.36);
    }

    .status-badge.status-doing {
      color: var(--accent);
      background: rgba(0, 122, 255, 0.16);
      border-color: rgba(0, 122, 255, 0.34);
    }

    .status-badge.status-blocked {
      color: var(--bad);
      background: rgba(255, 59, 48, 0.16);
      border-color: rgba(255, 59, 48, 0.34);
    }

    .status-badge.status-done {
      color: var(--good);
      background: rgba(52, 199, 89, 0.16);
      border-color: rgba(52, 199, 89, 0.32);
    }

    .empty {
      font-size: 12px;
      color: var(--muted);
      padding: 8px;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(460px, 94vw);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border-left: 1px solid var(--border);
      box-shadow: -18px 0 40px var(--shadow);
      transform: translateX(100%);
      transition: transform 0.24s ease;
      z-index: 20;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      padding: 18px 18px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .drawer-body {
      padding: 16px 18px;
      display: grid;
      gap: 14px;
      overflow: auto;
    }

    .drawer-footer {
      padding: 12px 18px 18px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .drawer-title {
      font-weight: 600;
      font-size: 18px;
      font-family: var(--display);
    }

    .drawer-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .drawer-section {
      display: grid;
      gap: 8px;
      padding: 12px 14px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: var(--panel-2);
    }

    .drawer-label {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .drawer-value {
      font-size: 13px;
      color: var(--text);
    }

    .drawer-grid {
      display: grid;
      gap: 10px;
    }

    .drawer-meta {
      display: grid;
      gap: 4px;
    }

    .drawer-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .drawer-pill {
      padding: 5px 10px;
      border-radius: 0;
      background: var(--panel);
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: border-color 0.15s ease, transform 0.15s ease;
    }

    .drawer-pill:hover {
      transform: translateY(-1px);
      border-color: rgba(0, 122, 255, 0.35);
    }

    .dep-dot {
      width: 6px;
      height: 6px;
      border-radius: 0;
      background: var(--muted);
    }

    .dep-dot.todo {
      background: var(--muted);
    }

    .dep-dot.doing {
      background: var(--accent);
    }

    .dep-dot.blocked {
      background: var(--bad);
    }

    .dep-dot.done {
      background: var(--good);
    }

    .dep-graph {
      width: 100%;
      height: 140px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: var(--panel);
      display: block;
      transition: transform 0.12s ease;
    }

    .dep-graph-wrap {
      position: relative;
      overflow: hidden;
      border-radius: 0;
    }

    .graph-controls {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      margin-top: 8px;
    }

    .graph-btn {
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 0;
      font-size: 11px;
      cursor: pointer;
      transition: border-color 0.15s ease, transform 0.15s ease;
    }

    .graph-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(0, 122, 255, 0.35);
    }

    .tooltip {
      position: fixed;
      z-index: 40;
      padding: 10px 12px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-size: 11px;
      box-shadow: 0 8px 20px var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease;
      max-width: 260px;
    }

    .tooltip-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .tooltip.show {
      opacity: 1;
    }

    .view-toggle {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      padding: 3px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: var(--panel);
    }

    .view-btn {
      border: 0;
      background: transparent;
      color: var(--muted);
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      z-index: 5;
    }

    .view-btn:hover {
      color: var(--accent);
      background: rgba(0, 240, 255, 0.1);
    }

    .view-btn.active {
      color: var(--accent);
      background: rgba(0, 240, 255, 0.2);
      border-left: 2px solid var(--accent);
    }

    .order-toggle {
      width: 100%;
      justify-content: center;
      padding: 10px 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .table-wrap {
      margin-top: 20px;
      border: 1px solid var(--border);
      border-radius: 0;
      background: var(--panel);
      overflow: hidden;
      animation: fade-up 0.55s ease both;
      animation-delay: 0.08s;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead th {
      text-align: left;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--panel-2);
    }

    tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    tbody tr {
      transition: background 0.15s ease;
    }

    tbody tr:hover {
      background: rgba(0, 122, 255, 0.08);
    }

    .table-id {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
    }

    .table-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .table-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 16, 15, 0.32);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 10;
    }

    .overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .footer-note {
      margin-top: 18px;
      font-size: 12px;
      color: var(--muted);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 18px;
      padding-bottom: 20px;
    }

    .dash-card {
      padding: 18px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(12, 16, 22, 0.9), rgba(10, 12, 18, 0.6));
      box-shadow: 0 0 0 1px rgba(0, 240, 255, 0.08), 0 18px 28px rgba(0, 0, 0, 0.35);
    }

    .dash-hero {
      grid-column: span 12;
    }

    .dash-half {
      grid-column: span 6;
    }

    .dash-third {
      grid-column: span 4;
    }

    .dash-title {
      font-family: var(--display);
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: var(--accent);
    }

    .dash-meta {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .kpi-card {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(8, 12, 16, 0.8);
      border: 1px solid var(--border);
      display: grid;
      gap: 6px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .kpi-card:hover {
      border-color: var(--border-active);
      box-shadow: 0 0 18px rgba(0, 240, 255, 0.12);
      transform: translateY(-2px);
    }

    .kpi-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-dim);
    }

    .kpi-value {
      font-size: 24px;
      font-family: var(--display);
      color: var(--text);
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .bar-grid {
      display: grid;
      gap: 10px;
    }

    .bar-row {
      display: grid;
      grid-template-columns: 110px 1fr 48px;
      gap: 10px;
      align-items: center;
    }

    .bar-label {
      font-size: 11px;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
    }

    .bar-track {
      position: relative;
      height: 8px;
      border-radius: 999px;
      background: rgba(0, 240, 255, 0.08);
      overflow: hidden;
      border: 1px solid rgba(0, 240, 255, 0.2);
    }

    .bar-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, rgba(0, 240, 255, 0.6), rgba(255, 0, 85, 0.4));
      box-shadow: 0 0 10px rgba(0, 240, 255, 0.4);
    }

    .bar-value {
      font-size: 11px;
      color: var(--text-dim);
      text-align: right;
    }

    .dash-list {
      display: grid;
      gap: 8px;
    }

    .dash-list-item {
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(8, 12, 16, 0.85);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--text);
    }

    .dash-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
    }

    .preset-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .preset-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0, 240, 255, 0.08);
      color: var(--text);
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .preset-btn.active {
      border-color: var(--border-active);
      box-shadow: 0 0 12px rgba(0, 240, 255, 0.2);
    }

    @media (max-width: 1100px) {
      .dash-half {
        grid-column: span 12;
      }

      .dash-third {
        grid-column: span 6;
      }
    }

    @media (max-width: 720px) {
      .dash-third {
        grid-column: span 12;
      }

      .bar-row {
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .bar-value {
        text-align: left;
      }
    }
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-text">CODEX<br>SWARM</div>
      <div class="logo-sub">Task Control</div>
    </div>

    <nav class="nav-menu">
      <div class="nav-item active" data-tab="tasks">
        <span>Tasks</span>
      </div>
      <div class="nav-item" data-tab="dashboard">
        <span>Dashboard</span>
      </div>
      <div class="nav-item" data-tab="agents">
        <span>Agents</span>
      </div>
      <div class="nav-item" data-tab="system">
        <span>System</span>
      </div>
    </nav>

    <div class="sidebar-footer">
      v0.2.0-CYBER
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- CONTROL DECK -->
    <div class="control-deck">
      <div class="view-title" id="pageTitle">Tasks</div>
      <div class="deck-actions">
        <button class="btn" id="reload">Refresh Stream</button>
        <div class="view-toggle" id="viewToggle">
          <button class="view-btn active" data-view="kanban" type="button">BOARD</button>
          <button class="view-btn" data-view="table" type="button">LIST</button>
        </div>
      </div>
    </div>

    <!-- VIEWPORT -->
    <div class="viewport">

      <!-- TAB: TASKS -->
      <div id="tab-tasks" class="tab-content active">

        <!-- Task Controls -->
        <div class="panel">
          <div class="controls-grid">
            <label>
              Search
              <input id="q" type="text" placeholder="Search datastream..." />
            </label>
            <label>
              Status
              <select id="status">
                <option value="">ALL</option>
                <option value="TODO">TODO</option>
                <option value="DOING">DOING</option>
                <option value="BLOCKED">BLOCKED</option>
                <option value="DONE">DONE</option>
              </select>
            </label>
            <label>
              Owner
              <select id="owner">
                <option value="">ALL</option>
              </select>
            </label>
            <label>
              Priority
              <select id="priority">
                <option value="">ALL</option>
              </select>
            </label>
            <label>
              Tag
              <select id="tag">
                <option value="">ALL</option>
              </select>
            </label>
            <label>
              Sort
              <select id="sort">
                <option value="status">STATUS</option>
                <option value="priority">PRIORITY</option>
                <option value="owner">OWNER</option>
              </select>
            </label>
            <label>
              Order
              <button class="btn order-toggle" id="orderToggle" type="button">
                <span id="orderLabel">Order: Normal</span>
              </button>
            </label>
          </div>
          <div
            style="padding: 12px 20px; border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
            <div class="chips" id="summary"></div>
            <div class="status-line" id="statusLine">System Ready</div>
          </div>
        </div>

        <!-- Task Board/Table -->
        <section class="board" id="board"></section>
        <div class="table-wrap" id="tableView" hidden>
          <table>
            <thead>
              <tr>
                <th>Task</th>
                <th>Status</th>
                <th>Owner</th>
                <th>Priority</th>
                <th>Tags</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

      </div>

      <!-- TAB: DASHBOARD -->
      <div id="tab-dashboard" class="tab-content">
        <div class="dashboard-grid">
          <div class="panel dash-card dash-hero">
            <div class="dash-title">Signal Board</div>
            <div class="dash-meta" id="dashboardMeta">Awaiting data stream...</div>
            <div class="kpi-grid" id="kpiGrid"></div>
          </div>

          <div class="panel dash-card dash-half">
            <div class="dash-title">Presets</div>
            <div class="dash-meta">Apply quick filters to the task stream.</div>
            <div class="preset-grid" id="presetGrid"></div>
            <div class="dash-meta" id="presetStatus"></div>
          </div>

          <div class="panel dash-card dash-half">
            <div class="dash-title">Health Signals</div>
            <div class="dash-meta">Risk and hygiene indicators.</div>
            <div class="dash-list" id="healthList"></div>
          </div>

          <div class="panel dash-card dash-third">
            <div class="dash-title">Owner Load</div>
            <div class="dash-meta">Top task owners.</div>
            <div class="bar-grid" id="ownerBars"></div>
          </div>

          <div class="panel dash-card dash-third">
            <div class="dash-title">Priority Mix</div>
            <div class="dash-meta">Distribution by priority.</div>
            <div class="bar-grid" id="priorityBars"></div>
          </div>

          <div class="panel dash-card dash-third">
            <div class="dash-title">Top Tags</div>
            <div class="dash-meta">Dominant tag signals.</div>
            <div class="bar-grid" id="tagBars"></div>
          </div>

          <div class="panel dash-card dash-half">
            <div class="dash-title">Dependencies</div>
            <div class="dash-meta">Tasks with dependency signals.</div>
            <div class="dash-list" id="dependencyList"></div>
          </div>

          <div class="panel dash-card dash-half">
            <div class="dash-title">Documentation</div>
            <div class="dash-meta">Docs and verification coverage.</div>
            <div class="dash-list" id="docList"></div>
          </div>
        </div>
      </div>

      <!-- TAB: AGENTS -->
      <div id="tab-agents" class="tab-content">
        <div class="panel" style="padding: 20px;">
          <div class="agent-grid" id="agentGrid">
            <!-- Agents injected here -->
            <div style="padding: 20px; color: var(--muted);">Initializing agent link...</div>
          </div>
        </div>
      </div>

      <!-- TAB: SYSTEM -->
      <div id="tab-system" class="tab-content">
        <div class="system-stats" id="systemStats">
          <!-- Stats injected here -->
        </div>
      </div>

    </div>
  </main>

  <div class="overlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div>
        <div class="drawer-title" id="drawerTitle">Task</div>
        <div class="drawer-subtitle" id="drawerSubtitle"></div>
      </div>
      <button class="btn" id="drawerClose">CLOSE</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
    <div class="drawer-footer">
      <button class="btn btn-primary" id="drawerSave">UPDATE STATUS</button>
    </div>
  </aside>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const STATUS_ORDER = ["TODO", "DOING", "BLOCKED", "DONE"];
    const PRIORITY_ORDER = ["high", "med", "low"];
    const STATUS_LABELS = {
      TODO: "To do",
      DOING: "In progress",
      BLOCKED: "Blocked",
      DONE: "Done",
    };
    const PRESETS = [
      { id: "blocked", label: "Blocked Only", status: "BLOCKED" },
      { id: "no-commit", label: "No Commit", flag: "no-commit" },
      { id: "no-verify", label: "No Verify", flag: "no-verify" },
      { id: "no-tags", label: "No Tags", flag: "no-tags" },
      { id: "has-deps", label: "Has Dependencies", flag: "has-deps" },
      { id: "dirty", label: "Dirty Flag", flag: "dirty" },
    ];

    let STATE = {
      tasks: [],
      byId: new Map(),
      dependentsById: new Map(),
      presetKey: localStorage.getItem("preset-key") || "",
    };
    let SELECTED_ID = "";
    let VIEW_MODE = localStorage.getItem("view-mode") || "kanban";
    let GRAPH_SCALE = 1;
    let ORDER_MODE = localStorage.getItem("order-mode") || "asc";

    const statusLine = document.getElementById("statusLine");

    function setStatusLine(text, tone = "") {
      statusLine.textContent = text;
      statusLine.style.color = tone || "";
    }

    function shorten(text, max = 18) {
      const clean = String(text || "").trim();
      if (!clean) return "";
      if (clean.length <= max) return clean;
      return `${clean.slice(0, max)}...`;
    }

    function getActiveFilters() {
      const q = String(document.getElementById("q").value || "").trim();
      const status = String(document.getElementById("status").value || "");
      const owner = String(document.getElementById("owner").value || "");
      const priority = String(document.getElementById("priority").value || "");
      const tag = String(document.getElementById("tag").value || "");
      const parts = [];
      if (q) parts.push(`search="${shorten(q, 18)}"`);
      if (status) parts.push(`status=${STATUS_LABELS[status] || status}`);
      if (STATE.presetKey) {
        const preset = PRESETS.find((p) => p.id === STATE.presetKey);
        if (preset) parts.push(`preset=${preset.label}`);
      }
      if (owner) parts.push(`owner=${shorten(owner, 14)}`);
      if (priority) parts.push(`priority=${priority}`);
      if (tag) parts.push(`tag=${shorten(tag, 14)}`);
      return parts;
    }

    function updateHeaderMeta(filteredCount, totalCount) {
      const meta = document.getElementById("headerMeta");
      if (!meta) return;
      const viewLabel = VIEW_MODE === "table" ? "Table" : "Kanban";
      const orderLabel = ORDER_MODE === "desc" ? "Reverse" : "Normal";
      const filters = getActiveFilters();
      const filterText = filters.length ? `Filters: ${filters.join(", ")}` : "Filters: none";
      meta.textContent = `Showing ${filteredCount} of ${totalCount} tasks - ${viewLabel} - Order: ${orderLabel} - ${filterText}`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function displayId(id) {
      return String(id || "").replace(/^[0-9]{12}-/, "");
    }

    function statusBadge(status) {
      const key = String(status || "TODO").toLowerCase();
      return `<span class="status-badge status-${key}"><span class="badge-dot"></span>${escapeHtml(status || "TODO")}</span>`;
    }

    function tagHue(tag) {
      let hash = 0;
      for (let i = 0; i < tag.length; i++) {
        hash = (hash * 31 + tag.charCodeAt(i)) | 0;
      }
      return Math.abs(hash) % 360;
    }

    function tagStyle(tag) {
      const h = tagHue(tag);
      return `background: hsla(${h}, 45%, 45%, 0.18); border-color: hsla(${h}, 45%, 55%, 0.45);`;
    }

    function renderTags(tags, clickable) {
      if (!tags.length) return "-";
      return tags
        .map(
          (t) =>
            `<span class="tag ${clickable ? "tag-btn" : ""}" data-tag="${escapeHtml(t)}" style="${tagStyle(t)}">${escapeHtml(t)}</span>`,
        )
        .join(" ");
    }

    function tooltipHtml(task) {
      const tags = renderTags(task.tags, false);
      const idShort = displayId(task.id);
      const idLine = idShort === task.id ? idShort : `${idShort} (full: ${escapeHtml(task.id)})`;
      return `
          <div style="font-weight:600; margin-bottom:4px;">${escapeHtml(task.title)}</div>
          <div class="table-sub">${escapeHtml(idLine)} ${statusBadge(task.status)}</div>
          <div class="table-sub">Owner: ${escapeHtml(task.owner || "-")} - Priority: ${escapeHtml(task.priority || "-")}</div>
          <div class="tooltip-tags">${tags}</div>
        `;
    }

    function showTooltip(content, x, y) {
      const tip = document.getElementById("tooltip");
      tip.innerHTML = content;
      tip.style.left = `${x + 12}px`;
      tip.style.top = `${y + 12}px`;
      tip.classList.add("show");
    }

    function hideTooltip() {
      document.getElementById("tooltip").classList.remove("show");
    }

    function addTooltipHandlers(el, task) {
      if (!el || !task) return;
      el.addEventListener("mousemove", (ev) => showTooltip(tooltipHtml(task), ev.clientX, ev.clientY));
      el.addEventListener("mouseenter", (ev) => showTooltip(tooltipHtml(task), ev.clientX, ev.clientY));
      el.addEventListener("mouseleave", hideTooltip);
    }

    function normalizeTask(task) {
      const status = String(task.status || "TODO").toUpperCase();
      const dependsRaw = task.depends_on || task.dependsOn || [];
      return {
        id: String(task.id || ""),
        title: String(task.title || "").trim() || "Untitled",
        description: String(task.description || "").trim(),
        status: STATUS_ORDER.includes(status) ? status : "TODO",
        owner: String(task.owner || "").trim(),
        priority: String(task.priority || "").trim(),
        tags: Array.isArray(task.tags) ? task.tags.filter(Boolean).map(String) : [],
        dependsOn: Array.isArray(dependsRaw) ? dependsRaw.map(String) : [],
        comments: Array.isArray(task.comments) ? task.comments : [],
        verify: Array.isArray(task.verify) ? task.verify : [],
        commit: task.commit || null,
        dirty: Boolean(task.dirty),
        doc: typeof task.doc === "string" ? task.doc : "",
        docUpdatedAt: task.doc_updated_at || "",
        idSource: task.id_source || "",
      };
    }

    function buildDependents(tasks) {
      const map = new Map();
      tasks.forEach((task) => {
        (task.dependsOn || []).forEach((dep) => {
          if (!map.has(dep)) map.set(dep, []);
          map.get(dep).push(task.id);
        });
      });
      return map;
    }

    function applyData(data) {
      const raw = Array.isArray(data?.tasks) ? data.tasks : [];
      const tasks = raw.map(normalizeTask).filter((t) => t.id);
      STATE.tasks = tasks;
      STATE.byId = new Map(tasks.map((t) => [t.id, t]));
      STATE.dependentsById = buildDependents(tasks);

      fillSelect("owner", optionify(tasks.map((t) => t.owner).filter(Boolean)));
      fillSelect("priority", optionify(tasks.map((t) => t.priority).filter(Boolean)));
      fillSelect("tag", optionify(tasks.flatMap((t) => t.tags || [])));
      renderSummary(tasks);
      renderDashboard();
      renderView();
    }

    function optionify(values) {
      return [...new Set(values)].sort((a, b) => String(a).localeCompare(String(b)));
    }

    function fillSelect(id, values) {
      const select = document.getElementById(id);
      const keep = select.value;
      select.querySelectorAll("option:not([value=''])").forEach((o) => o.remove());
      for (const v of values) {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      }
      if (values.includes(keep)) select.value = keep;
    }

    function renderSummary(tasks) {
      const summary = document.getElementById("summary");
      summary.innerHTML = "";
      const total = tasks.length;
      const selected = String(document.getElementById("status").value || "");
      const counts = STATUS_ORDER.reduce((acc, st) => {
        acc[st] = tasks.filter((t) => t.status === st).length;
        return acc;
      }, {});

      const chips = [
        { label: `Total ${total}`, dot: "todo", status: "" },
        { label: `TODO ${counts.TODO}`, dot: "todo", status: "TODO" },
        { label: `DOING ${counts.DOING}`, dot: "doing", status: "DOING" },
        { label: `BLOCKED ${counts.BLOCKED}`, dot: "blocked", status: "BLOCKED" },
        { label: `DONE ${counts.DONE}`, dot: "done", status: "DONE" },
      ];

      chips.forEach((item) => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.dataset.status = item.status;
        chip.classList.toggle("active", item.status === selected);
        chip.innerHTML = `<span class="dot ${item.dot}"></span><span>${item.label}</span>`;
        chip.addEventListener("click", () => {
          document.getElementById("status").value = item.status;
          renderView();
        });
        summary.appendChild(chip);
      });
    }

    function applyFilters(tasks) {
      const q = String(document.getElementById("q").value || "").trim().toLowerCase();
      const status = String(document.getElementById("status").value || "");
      const owner = String(document.getElementById("owner").value || "");
      const priority = String(document.getElementById("priority").value || "");
      const tag = String(document.getElementById("tag").value || "");

      return tasks.filter((t) => {
        if (!passesPreset(t)) return false;
        if (status && t.status !== status) return false;
        if (owner && t.owner !== owner) return false;
        if (priority && t.priority !== priority) return false;
        if (tag && !t.tags.includes(tag)) return false;
        if (!q) return true;
        return t.title.toLowerCase().includes(q);
      });
    }

    function passesPreset(task) {
      const preset = STATE.presetKey;
      if (!preset) return true;
      if (preset === "blocked") return task.status === "BLOCKED";
      if (preset === "no-commit") return !task.commit;
      if (preset === "no-verify") return !task.verify.length;
      if (preset === "no-tags") return !task.tags.length;
      if (preset === "has-deps") return task.dependsOn.length > 0;
      if (preset === "dirty") return task.dirty === true;
      return true;
    }

    function setPreset(key) {
      STATE.presetKey = key || "";
      localStorage.setItem("preset-key", STATE.presetKey);
      if (STATE.presetKey === "blocked") {
        document.getElementById("status").value = "BLOCKED";
      } else if (STATE.presetKey) {
        document.getElementById("status").value = "";
      }
      renderDashboard();
      renderView();
    }

    function countBy(tasks, selector) {
      const map = new Map();
      tasks.forEach((t) => {
        const key = selector(t);
        if (!key) return;
        map.set(key, (map.get(key) || 0) + 1);
      });
      return [...map.entries()].sort((a, b) => b[1] - a[1]);
    }

    function renderBarList(targetId, rows, max = 6, clickHandler) {
      const root = document.getElementById(targetId);
      if (!root) return;
      root.innerHTML = "";
      if (!rows.length) {
        root.innerHTML = `<div class="dash-list-item">No signals detected.</div>`;
        return;
      }
      const top = rows.slice(0, max);
      const peak = top[0][1] || 1;
      top.forEach(([label, value]) => {
        const row = document.createElement("div");
        row.className = "bar-row";
        const safeLabel = escapeHtml(label);
        row.innerHTML = `
          <div class="bar-label" data-label="${safeLabel}">${safeLabel}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${Math.round((value / peak) * 100)}%"></div></div>
          <div class="bar-value">${value}</div>
        `;
        if (clickHandler) {
          row.querySelector(".bar-label")?.addEventListener("click", () => clickHandler(label));
        }
        root.appendChild(row);
      });
    }

    function renderList(targetId, items) {
      const root = document.getElementById(targetId);
      if (!root) return;
      root.innerHTML = "";
      if (!items.length) {
        root.innerHTML = `<div class="dash-list-item">No signals detected.</div>`;
        return;
      }
      items.forEach((item) => {
        const row = document.createElement("div");
        row.className = "dash-list-item";
        row.innerHTML = `
          <span>${item.label}</span>
          <span class="dash-pill" data-action="${escapeHtml(item.action || "")}">${escapeHtml(item.value)}</span>
        `;
        if (item.onClick) {
          row.querySelector(".dash-pill")?.addEventListener("click", item.onClick);
        }
        root.appendChild(row);
      });
    }

    function renderDashboard() {
      const tasks = STATE.tasks;
      const filtered = applyFilters(tasks);
      const total = tasks.length;
      const counts = STATUS_ORDER.reduce((acc, st) => {
        acc[st] = tasks.filter((t) => t.status === st).length;
        return acc;
      }, {});
      const filteredPct = total ? Math.round((filtered.length / total) * 100) : 0;
      const docCount = tasks.filter((t) => t.doc).length;
      const commitCount = tasks.filter((t) => t.commit).length;
      const verifyCount = tasks.filter((t) => t.verify.length).length;
      const dirtyCount = tasks.filter((t) => t.dirty).length;
      const depCount = tasks.filter((t) => t.dependsOn.length).length;

      const meta = document.getElementById("dashboardMeta");
      if (meta) {
        meta.textContent = `Total ${total} tasks. Active filters cover ${filtered.length} (${filteredPct}%).`;
      }

      const kpiGrid = document.getElementById("kpiGrid");
      if (kpiGrid) {
        kpiGrid.innerHTML = "";
        const kpis = [
          { label: "Total Tasks", value: total, sub: "All records", action: () => setPreset("") },
          { label: "Doing", value: counts.DOING, sub: "In progress", action: () => setPreset(""), status: "DOING" },
          { label: "Blocked", value: counts.BLOCKED, sub: "Needs attention", action: () => setPreset("blocked") },
          { label: "Done", value: counts.DONE, sub: "Completed", action: () => setPreset("") },
          { label: "No Commit", value: total - commitCount, sub: "Missing commit hash", action: () => setPreset("no-commit") },
          { label: "No Verify", value: total - verifyCount, sub: "Missing verify steps", action: () => setPreset("no-verify") },
          { label: "Dirty Flag", value: dirtyCount, sub: "Needs cleanup", action: () => setPreset("dirty") },
          { label: "Dependencies", value: depCount, sub: "Has deps", action: () => setPreset("has-deps") },
        ];

        kpis.forEach((kpi) => {
          const card = document.createElement("div");
          card.className = "kpi-card";
          card.innerHTML = `
            <div class="kpi-label">${escapeHtml(kpi.label)}</div>
            <div class="kpi-value">${kpi.value}</div>
            <div class="kpi-sub">${escapeHtml(kpi.sub)}</div>
          `;
          card.addEventListener("click", () => {
            if (kpi.status) {
              document.getElementById("status").value = kpi.status;
            }
            kpi.action?.();
          });
          kpiGrid.appendChild(card);
        });
      }

      renderBarList("ownerBars", countBy(tasks, (t) => t.owner || "Unknown"), 6, (value) => {
        document.getElementById("owner").value = value === "Unknown" ? "" : value;
        setPreset("");
      });
      renderBarList("priorityBars", countBy(tasks, (t) => t.priority || "none"), 6, (value) => {
        document.getElementById("priority").value = value === "none" ? "" : value;
        setPreset("");
      });
      renderBarList("tagBars", countBy(tasks.flatMap((t) => t.tags.map((tag) => ({ tag }))), (t) => t.tag), 6, (value) => {
        document.getElementById("tag").value = value;
        setPreset("");
      });

      const healthItems = [
        {
          label: "No commit attached",
          value: `${total - commitCount}`,
          onClick: () => setPreset("no-commit"),
        },
        {
          label: "Missing verify steps",
          value: `${total - verifyCount}`,
          onClick: () => setPreset("no-verify"),
        },
        {
          label: "No tags",
          value: `${tasks.filter((t) => !t.tags.length).length}`,
          onClick: () => setPreset("no-tags"),
        },
        {
          label: "Dirty flagged",
          value: `${dirtyCount}`,
          onClick: () => setPreset("dirty"),
        },
      ];
      renderList("healthList", healthItems);

      const depItems = [
        {
          label: "Has dependencies",
          value: `${depCount}`,
          onClick: () => setPreset("has-deps"),
        },
        {
          label: "No dependencies",
          value: `${tasks.filter((t) => !t.dependsOn.length).length}`,
          onClick: () => setPreset(""),
        },
        {
          label: "Blocked with deps",
          value: `${tasks.filter((t) => t.status === "BLOCKED" && t.dependsOn.length).length}`,
          onClick: () => setPreset("blocked"),
        },
      ];
      renderList("dependencyList", depItems);

      const docItems = [
        {
          label: "Docs present",
          value: `${docCount}`,
          onClick: () => setPreset(""),
        },
        {
          label: "Docs missing",
          value: `${total - docCount}`,
          onClick: () => setPreset(""),
        },
        {
          label: "Verify steps",
          value: `${verifyCount}`,
          onClick: () => setPreset(""),
        },
      ];
      renderList("docList", docItems);

      const presetGrid = document.getElementById("presetGrid");
      if (presetGrid) {
        presetGrid.innerHTML = "";
        PRESETS.forEach((preset) => {
          const btn = document.createElement("button");
          btn.className = "preset-btn";
          btn.textContent = preset.label;
          btn.classList.toggle("active", preset.id === STATE.presetKey);
          btn.addEventListener("click", () => {
            if (preset.status) {
              document.getElementById("status").value = preset.status;
            }
            setPreset(preset.id === STATE.presetKey ? "" : preset.id);
          });
          presetGrid.appendChild(btn);
        });
      }

      const presetStatus = document.getElementById("presetStatus");
      if (presetStatus) {
        const active = PRESETS.find((p) => p.id === STATE.presetKey);
        presetStatus.textContent = active ? `Active preset: ${active.label}` : "No preset active.";
      }
    }

    function sortTasks(tasks, mode, reverse) {
      const sorted = [...tasks];
      const compare = {
        status: (a, b) => STATUS_ORDER.indexOf(a.status) - STATUS_ORDER.indexOf(b.status),
        owner: (a, b) => String(a.owner).localeCompare(String(b.owner)),
        priority: (a, b) => {
          const ai = PRIORITY_ORDER.indexOf(a.priority);
          const bi = PRIORITY_ORDER.indexOf(b.priority);
          return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
        },
        tag: (a, b) => String(a.tags[0] || "").localeCompare(String(b.tags[0] || "")),
      }[mode];

      sorted.sort((a, b) => {
        const primary = compare ? compare(a, b) : 0;
        if (primary !== 0) return primary;
        return a.id.localeCompare(b.id);
      });
      if (reverse) sorted.reverse();
      return sorted;
    }

    function renderBoard(filtered) {
      const board = document.getElementById("board");
      board.innerHTML = "";
      renderSummary(filtered);

      const sortMode = String(document.getElementById("sort").value || "status");
      const reverse = ORDER_MODE === "desc";

      STATUS_ORDER.forEach((status) => {
        const col = document.createElement("div");
        col.className = "column";
        col.dataset.status = status;
        const header = document.createElement("div");
        header.className = "column-header";
        header.innerHTML = `<div class="column-title">${STATUS_LABELS[status]}</div><div class="meta">${filtered.filter((t) => t.status === status).length}</div>`;
        const body = document.createElement("div");
        body.className = "column-body";
        body.dataset.status = status;

        const tasks = sortTasks(filtered.filter((t) => t.status === status), sortMode, reverse);

        if (!tasks.length) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "No tasks";
          body.appendChild(empty);
        } else {
          tasks.forEach((task, idx) => body.appendChild(renderCard(task, idx)));
        }

        wireDrop(body);
        col.appendChild(header);
        col.appendChild(body);
        board.appendChild(col);
      });
    }

    function renderTable(filtered) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      if (!filtered.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 5;
        cell.className = "table-sub";
        cell.textContent = "No tasks";
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }
      const sortMode = String(document.getElementById("sort").value || "status");
      const reverse = ORDER_MODE === "desc";
      const sorted = sortTasks(filtered, sortMode, reverse);
      sorted.forEach((task) => {
        const row = document.createElement("tr");
        row.style.cursor = "pointer";
        row.addEventListener("click", () => openDrawer(task.id));
        row.innerHTML = `
            <td>
              <div class="table-title">${escapeHtml(task.title)}</div>
              <div class="table-id">${escapeHtml(displayId(task.id))}</div>
            </td>
            <td>${statusBadge(task.status)}</td>
            <td>${escapeHtml(task.owner || "-")}</td>
            <td>${escapeHtml(task.priority || "-")}</td>
            <td>${renderTags(task.tags, false)}</td>
          `;
        tbody.appendChild(row);
        addTooltipHandlers(row, task);
      });
    }

    function setViewMode(mode) {
      VIEW_MODE = mode;
      localStorage.setItem("view-mode", mode);
      document.querySelectorAll(".view-btn").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.view === mode);
      });
      const board = document.getElementById("board");
      const table = document.getElementById("tableView");
      if (board) {
        board.hidden = mode !== "kanban";
        board.style.display = mode === "kanban" ? "grid" : "none";
      }
      if (table) {
        table.hidden = mode !== "table";
        table.style.display = mode === "table" ? "block" : "none";
      }
    }

    function renderView() {
      const filtered = applyFilters(STATE.tasks);
      renderSummary(filtered);
      if (VIEW_MODE === "table") {
        renderTable(filtered);
      } else {
        renderBoard(filtered);
      }
      updateHeaderMeta(filtered.length, STATE.tasks.length);
      renderDashboard();
    }

    function renderCard(task, idx) {
      const card = document.createElement("div");
      card.className = "card";
      card.draggable = window.location.protocol !== "file:";
      card.dataset.id = task.id;
      card.dataset.status = task.status.toLowerCase();
      card.style.animationDelay = `${Math.min(idx, 8) * 0.03}s`;
      card.addEventListener("click", (ev) => {
        const tagEl = ev.target.closest(".tag-btn");
        if (tagEl) {
          ev.stopPropagation();
          const tag = tagEl.dataset.tag || "";
          if (tag) {
            document.getElementById("tag").value = tag;
            renderView();
          }
          return;
        }
        openDrawer(task.id);
      });

      const meta = [displayId(task.id)];
      if (task.owner) meta.push(task.owner);
      if (task.priority) meta.push(task.priority);

      card.innerHTML = `
          <div class="card-title">${escapeHtml(task.title)}</div>
          <div class="card-meta">
            ${meta.map((m) => `<span>${escapeHtml(m)}</span>`).join(" - ")}
            ${statusBadge(task.status)}
          </div>
          ${task.description
          ? `<div class="card-desc">${escapeHtml(task.description.slice(0, 160))}${task.description.length > 160 ? "..." : ""}</div>`
          : ""
        }
          <div class="card-tags">${renderTags(task.tags, true)}</div>
        `;

      addTooltipHandlers(card, task);
      card.addEventListener("dragstart", (ev) => {
        ev.dataTransfer?.setData("text/plain", task.id);
        ev.dataTransfer.effectAllowed = "move";
      });

      return card;
    }

    function wireDrop(zone) {
      zone.addEventListener("dragover", (ev) => {
        ev.preventDefault();
        zone.classList.add("drag-over");
      });
      zone.addEventListener("dragleave", () => zone.classList.remove("drag-over"));
      zone.addEventListener("drop", async (ev) => {
        ev.preventDefault();
        zone.classList.remove("drag-over");
        const taskId = ev.dataTransfer?.getData("text/plain");
        if (!taskId) return;
        const targetStatus = zone.dataset.status;
        const task = STATE.byId.get(taskId);
        if (!task || task.status === targetStatus) return;
        await updateStatus(taskId, targetStatus);
      });
    }

    async function updateStatus(taskId, status) {
      try {
        setStatusLine(`Updating ${taskId} -> ${status}...`);
        const res = await fetch(`/api/tasks/${encodeURIComponent(taskId)}/status`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status }),
        });
        const payload = await res.json();
        if (!res.ok || payload.error) {
          throw new Error(payload.error || "Update failed");
        }
        applyData(payload.data);
        setStatusLine(`Updated ${taskId} -> ${status}`, "var(--accent)");
        if (SELECTED_ID === taskId) {
          openDrawer(taskId);
        }
      } catch (err) {
        setStatusLine(`Failed: ${err.message || err}`, "var(--bad)");
      }
    }

    async function loadTasks() {
      const res = await fetch("/api/tasks", { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load /api/tasks: HTTP ${res.status}`);
      return res.json();
    }

    function wireControls() {
      ["q", "status", "owner", "priority", "tag", "sort"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", renderView);
        el.addEventListener("change", renderView);
      });
    }

    function statusClassFor(id) {
      const task = STATE.byId.get(id);
      if (!task) return "todo";
      const status = String(task.status || "").toLowerCase();
      if (status === "doing") return "doing";
      if (status === "blocked") return "blocked";
      if (status === "done") return "done";
      return "todo";
    }

    function renderDepPills(ids) {
      if (!ids.length) return "-";
      return ids
        .map(
          (id) => `
            <span class="drawer-pill" data-task-id="${escapeHtml(id)}">
              <span class="dep-dot ${statusClassFor(id)}"></span>
              <span>${escapeHtml(displayId(id))}</span>
            </span>
          `,
        )
        .join("");
    }

    function renderDepGraph(centerId, dependsOn, dependents) {
      const width = 320;
      const height = 140;
      const cx = width / 2;
      const cy = height / 2;
      const nodeW = 86;
      const nodeH = 22;
      const leftX = 12;
      const rightX = width - nodeW - 12;
      const leftY = dependsOn.length ? cy - ((dependsOn.length - 1) * (nodeH + 6)) / 2 : cy;
      const rightY = dependents.length ? cy - ((dependents.length - 1) * (nodeH + 6)) / 2 : cy;

      function node(id, x, y, statusClass, selected) {
        const fill = "var(--panel-2)";
        const stroke = selected ? "var(--accent)" : "var(--border)";
        const text = escapeHtml(displayId(id));
        const dotColor =
          statusClass === "doing"
            ? "var(--accent)"
            : statusClass === "blocked"
              ? "var(--bad)"
              : statusClass === "done"
                ? "var(--good)"
                : "var(--muted)";
        return `
            <g data-task-id="${escapeHtml(id)}">
              <rect x="${x}" y="${y}" rx="6" ry="6" width="${nodeW}" height="${nodeH}" fill="${fill}" stroke="${stroke}" stroke-width="1" />
              <circle cx="${x + 10}" cy="${y + nodeH / 2}" r="3" fill="${dotColor}" />
              <text x="${x + 18}" y="${y + 14}" font-size="10" fill="var(--text)" font-family="var(--mono)">${text}</text>
            </g>
          `;
      }

      function edge(x1, y1, x2, y2) {
        const dx = Math.max(18, Math.abs(x2 - x1) * 0.4);
        const d = `M ${x1} ${y1} C ${x1 + dx} ${y1}, ${x2 - dx} ${y2}, ${x2} ${y2}`;
        return `<path d="${d}" fill="none" stroke="var(--border)" stroke-width="1" marker-end="url(#arrow)" />`;
      }

      const leftNodes = dependsOn.slice(0, 4);
      const rightNodes = dependents.slice(0, 4);
      const leftExtra = Math.max(0, dependsOn.length - leftNodes.length);
      const rightExtra = Math.max(0, dependents.length - rightNodes.length);

      let svg = `<svg class="dep-graph" viewBox="0 0 ${width} ${height}" role="img">
          <defs>
            <marker id="arrow" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto">
              <path d="M0,0 L6,3 L0,6 Z" fill="var(--border)" />
            </marker>
          </defs>
        `;
      leftNodes.forEach((id, i) => {
        const y = leftY + i * (nodeH + 6);
        svg += edge(leftX + nodeW, y + nodeH / 2, cx - nodeW / 2, cy);
      });
      rightNodes.forEach((id, i) => {
        const y = rightY + i * (nodeH + 6);
        svg += edge(cx + nodeW / 2, cy, rightX, y + nodeH / 2);
      });

      svg += node(centerId, cx - nodeW / 2, cy - nodeH / 2, statusClassFor(centerId), true);
      leftNodes.forEach((id, i) => {
        const y = leftY + i * (nodeH + 6);
        svg += node(id, leftX, y, statusClassFor(id), false);
      });
      rightNodes.forEach((id, i) => {
        const y = rightY + i * (nodeH + 6);
        svg += node(id, rightX, y, statusClassFor(id), false);
      });

      if (leftExtra) {
        svg += `<text x="${leftX}" y="${height - 8}" font-size="10" fill="var(--muted)">+${leftExtra} more</text>`;
      }
      if (rightExtra) {
        svg += `<text x="${rightX}" y="${height - 8}" font-size="10" fill="var(--muted)">+${rightExtra} more</text>`;
      }

      svg += "</svg>";
      return svg;
    }

    function openDrawer(taskId) {
      const task = STATE.byId.get(taskId);
      if (!task) return;
      SELECTED_ID = taskId;
      const drawer = document.getElementById("drawer");
      const overlay = document.getElementById("drawerOverlay");
      document.getElementById("drawerTitle").textContent = `${displayId(task.id)} - ${task.title}`;
      document.getElementById("drawerSubtitle").innerHTML = statusBadge(task.status);
      const body = document.getElementById("drawerBody");
      const dependents = STATE.dependentsById.get(task.id) || [];
      const dependsOn = task.dependsOn || [];
      const commentsCount = Array.isArray(task.comments) ? task.comments.length : 0;
      const verifyCount = Array.isArray(task.verify) ? task.verify.length : 0;
      body.innerHTML = `
          <div class="drawer-section">
            <div class="drawer-label">Status</div>
            <select id="drawerStatus">
              ${STATUS_ORDER.map((st) => `<option value="${st}" ${st === task.status ? "selected" : ""}>${st}</option>`).join("")}
            </select>
          </div>
          <div class="drawer-grid">
            <div class="drawer-section drawer-meta">
              <div class="drawer-label">Owner</div>
              <div class="drawer-value">${escapeHtml(task.owner || "-")}</div>
            </div>
            <div class="drawer-section drawer-meta">
              <div class="drawer-label">Priority</div>
              <div class="drawer-value">${escapeHtml(task.priority || "-")}</div>
            </div>
            <div class="drawer-section drawer-meta">
              <div class="drawer-label">Tags</div>
              <div class="drawer-value">${renderTags(task.tags, false)}</div>
            </div>
          </div>
          <div class="drawer-section">
            <div class="drawer-label">Dependencies</div>
            <div class="dep-graph-wrap" id="depGraphWrap">
              ${renderDepGraph(task.id, dependsOn, dependents)}
            </div>
            <div class="graph-controls">
              <button class="graph-btn" id="graphZoomOut" type="button">-</button>
              <button class="graph-btn" id="graphZoomReset" type="button">100%</button>
              <button class="graph-btn" id="graphZoomIn" type="button">+</button>
            </div>
            <div class="drawer-meta">
              <div class="drawer-label">Depends on (${dependsOn.length})</div>
              <div class="drawer-pills">${renderDepPills(dependsOn)}</div>
            </div>
            <div class="drawer-meta">
              <div class="drawer-label">Dependents (${dependents.length})</div>
              <div class="drawer-pills">${renderDepPills(dependents)}</div>
            </div>
          </div>
          <div class="drawer-section">
            <div class="drawer-label">Additional</div>
            <div class="drawer-meta">
              <div class="drawer-label">Comments</div>
              <div class="drawer-value">${commentsCount}</div>
            </div>
            <div class="drawer-meta">
              <div class="drawer-label">Verify steps</div>
              <div class="drawer-value">${verifyCount || "-"}</div>
            </div>
            <div class="drawer-meta">
              <div class="drawer-label">Commit</div>
              <div class="drawer-value">${task.commit?.hash ? escapeHtml(String(task.commit.hash).slice(0, 12)) : "-"}</div>
            </div>
          </div>
          <div class="drawer-section">
            <div class="drawer-label">Description</div>
            <div class="drawer-value">${escapeHtml(task.description || "No description")}</div>
          </div>
        `;
      drawer.classList.add("open");
      overlay.classList.add("open");

      body.querySelectorAll("[data-task-id]").forEach((pill) => {
        const id = pill.getAttribute("data-task-id") || "";
        pill.addEventListener("click", () => {
          if (id) openDrawer(id);
        });
        const taskForTip = STATE.byId.get(id);
        addTooltipHandlers(pill, taskForTip);
      });

      const graphWrap = document.getElementById("depGraphWrap");
      const zoomLabel = document.getElementById("graphZoomReset");
      function setGraphScale(scale) {
        GRAPH_SCALE = Math.max(0.6, Math.min(1.6, scale));
        const svg = graphWrap?.querySelector("svg");
        if (svg) {
          svg.style.transform = `scale(${GRAPH_SCALE})`;
          svg.style.transformOrigin = "center center";
        }
        if (zoomLabel) zoomLabel.textContent = `${Math.round(GRAPH_SCALE * 100)}%`;
      }

      setGraphScale(1);
      document.getElementById("graphZoomOut")?.addEventListener("click", () => setGraphScale(GRAPH_SCALE - 0.1));
      document.getElementById("graphZoomIn")?.addEventListener("click", () => setGraphScale(GRAPH_SCALE + 0.1));
      document.getElementById("graphZoomReset")?.addEventListener("click", () => setGraphScale(1));
    }

    function closeDrawer() {
      SELECTED_ID = "";
      document.getElementById("drawer").classList.remove("open");
      document.getElementById("drawerOverlay").classList.remove("open");
    }

    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      updateThemeToggle();
    }

    function setOrderMode(mode, render = true) {
      ORDER_MODE = mode === "desc" ? "desc" : "asc";
      localStorage.setItem("order-mode", ORDER_MODE);
      updateOrderToggle();
      if (render) renderView();
    }

    function updateThemeToggle() {
      const btn = document.getElementById("themeToggle");
      if (!btn) return; // Element removed in cyberpunk UI
      const current = document.documentElement.getAttribute("data-theme") || "light";
      const label = current === "dark" ? "Theme: Dark" : "Theme: Light";
      btn.textContent = label;
    }

    function updateOrderToggle() {
      const btn = document.getElementById("orderToggle");
      if (!btn) return;
      const label = document.getElementById("orderLabel");
      const isReverse = ORDER_MODE === "desc";
      btn.classList.toggle("reverse", isReverse);
      btn.setAttribute("aria-pressed", String(isReverse));
      if (label) label.textContent = isReverse ? "Order: Reverse" : "Order: Normal";
      btn.title = isReverse ? "Switch to normal order" : "Switch to reverse order";
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      setTheme(current === "dark" ? "light" : "dark");
    }

    /* TABS SYSTEM */
    function wireTabs() {
      const tabs = document.querySelectorAll(".nav-item[data-tab]");
      console.log("wireTabs: found", tabs.length, "tabs");
      tabs.forEach(tab => {
        tab.addEventListener("click", (e) => {
          e.preventDefault();
          console.log("Tab clicked:", tab.dataset.tab);

          // Deactivate all
          document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));

          // Activate target
          tab.classList.add("active");
          const targetId = tab.dataset.tab;
          const targetEl = document.getElementById(`tab-${targetId}`);
          if (targetEl) {
            targetEl.classList.add("active");
          }

          // Update Title
          const span = tab.querySelector("span");
          if (span) {
            document.getElementById("pageTitle").textContent = span.textContent;
          }

          const viewToggle = document.getElementById("viewToggle");
          if (viewToggle) {
            viewToggle.style.display = targetId === "tasks" ? "flex" : "none";
          }

          // Lazy load
          if (targetId === "dashboard") renderDashboard();
          if (targetId === "agents") loadAgents();
          if (targetId === "system") renderSystemStats();
        });
      });
    }

    /* AGENTS SYSTEM */
    async function loadAgents() {
      const grid = document.getElementById("agentGrid");
      if (grid.dataset.loaded) return;

      try {
        grid.innerHTML = `<div style="padding:20px">Accessing Agent Uplink...</div>`;
        const res = await fetch("/api/agents");
        const data = await res.json();

        if (data.ok && data.agents) {
          renderAgents(data.agents);
          grid.dataset.loaded = "true";
        } else {
          throw new Error("Uplink failed");
        }
      } catch (err) {
        grid.innerHTML = `<div style="color:var(--bad)">CONNECTION FAILED: ${err.message}</div>`;
      }
    }

    function renderAgents(agents) {
      const grid = document.getElementById("agentGrid");
      grid.innerHTML = "";

      if (!agents.length) {
        grid.innerHTML = "No active agents found.";
        return;
      }

      agents.forEach(agent => {
        const card = document.createElement("div");
        card.className = "agent-card";

        const role = agent.role || "Specialist";
        const desc = agent.description || "No data available.";
        const model = agent.model || "Unknown";

        card.innerHTML = `
          <div class="agent-header">
            <div class="agent-id">${escapeHtml(agent.name || agent.id)}</div>
            <div class="status-badge status-doing">ACTIVE</div>
          </div>
          <div class="agent-role">${escapeHtml(role)}</div>
          <div class="agent-desc">${escapeHtml(desc)}</div>
          <div class="agent-meta">
            <div>MODEL: ${escapeHtml(model)}</div>
            <div>TOOLS: ${Array.isArray(agent.tools) ? agent.tools.length : 0}</div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    /* SYSTEM STATS */
    function renderSystemStats() {
      const stats = document.getElementById("systemStats");
      // Static stats for now + live task counts
      const taskCount = STATE.tasks.length;
      const doing = STATE.tasks.filter(t => t.status === "DOING").length;
      const withSource = STATE.tasks.filter((t) => t.idSource).length;
      const latestDoc = STATE.tasks
        .map((t) => t.docUpdatedAt)
        .filter(Boolean)
        .map((t) => new Date(t))
        .filter((d) => !Number.isNaN(d.valueOf()))
        .sort((a, b) => b - a)[0];

      stats.innerHTML = `
        <div class="stat-row">
           <div class="stat-label">System Status</div>
           <div class="stat-val" style="color:var(--good)">ONLINE</div>
        </div>
        <div class="stat-row">
           <div class="stat-label">Active Tasks</div>
           <div class="stat-val">${doing}</div>
        </div>
        <div class="stat-row">
           <div class="stat-label">Total Indexes</div>
           <div class="stat-val">${taskCount}</div>
        </div>
        <div class="stat-row">
           <div class="stat-label">Source Coverage</div>
           <div class="stat-val">${withSource}/${taskCount}</div>
        </div>
        <div class="stat-row">
           <div class="stat-label">Last Doc Update</div>
           <div class="stat-val">${latestDoc ? latestDoc.toLocaleString() : "n/a"}</div>
        </div>
        <div class="stat-row">
           <div class="stat-label">Theme Mode</div>
           <div class="stat-val">${document.documentElement.getAttribute("data-theme").toUpperCase()}</div>
        </div>
        <div class="stat-row">
           <div class="stat-label">User Agent</div>
           <div class="stat-val" style="font-size:12px">${navigator.userAgent.slice(0, 40)}...</div>
        </div>
      `;
    }

    async function main() {
      const storedTheme = localStorage.getItem("theme");
      // Force dark mode default for cyberpunk
      const theme = storedTheme || "dark";
      setTheme(theme);

      // Removed old theme/order toggles if they don't exist
      const themeBtn = document.getElementById("themeToggle");
      if (themeBtn) themeBtn.addEventListener("click", toggleTheme);

      const reloadBtn = document.getElementById("reload");
      if (reloadBtn) reloadBtn.addEventListener("click", () => window.location.reload());

      const orderToggle = document.getElementById("orderToggle");
      if (orderToggle) {
        orderToggle.addEventListener("click", () => {
          setOrderMode(ORDER_MODE === "asc" ? "desc" : "asc");
        });
      }

      wireControls();
      wireTabs();
      updateOrderToggle();

      document.querySelectorAll(".view-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const mode = btn.dataset.view;
          console.log("View toggle clicked:", mode);
          setViewMode(mode);
          renderView();
        });
      });
      setViewMode(VIEW_MODE);
      renderView(); // Ensure initial render

      if (window.location.protocol === "file:") {
        setStatusLine("Read-only in file mode.");
        return;
      }

      try {
        const data = await loadTasks();
        applyData(data);

        if (data?.meta?.warning) {
          setStatusLine(`Warning: ${data.meta.warning}`, "var(--warn)");
        } else if (!STATE.tasks.length) {
          setStatusLine("No tasks returned - check task source settings or filters.", "var(--warn)");
        } else {
          setStatusLine("Ready.");
        }

        const drawerClose = document.getElementById("drawerClose");
        if (drawerClose) drawerClose.addEventListener("click", closeDrawer);

        const drawerOverlay = document.getElementById("drawerOverlay");
        if (drawerOverlay) drawerOverlay.addEventListener("click", closeDrawer);

        const drawerSave = document.getElementById("drawerSave");
        if (drawerSave) drawerSave.addEventListener("click", async () => {
          if (!SELECTED_ID) return;
          const status = document.getElementById("drawerStatus")?.value || "";
          if (!status) return;
          await updateStatus(SELECTED_ID, status);
        });
      } catch (err) {
        setStatusLine(err.message || String(err), "var(--bad)");
      }
    }

    document.addEventListener("DOMContentLoaded", main);
  </script>
</body>

</html>
