# T-067: Align agentctl with branch_pr spec (worktrees, PR checks, integrate)

## Goal

- Bring `python scripts/agentctl.py` in line with the stricter `branch_pr` workflow spec:
  - task branches + worktrees rooted at `.codex-swarm/worktrees/`
  - PR artifacts under `docs/workflow/prs/T-###/` with strict validation
  - one-button integration (check → verify → merge → finish) for INTEGRATOR
  - standardized command output + anti-footgun errors

## Scope

- `agentctl` commands:
  - `branch create` spec compliance (naming, worktree root, reuse checks, ignore checks).
  - New `branch status`.
  - `pr open/update/check` spec compliance (files, meta fields, required sections + non-empty content).
  - `integrate` improvements: `--dry-run`, merge strategies incl. `rebase`, verify run in branch worktree, meta updates.
  - `finish` guardrails for `branch_pr` (main-only, not in worktrees, author allowlist, require PR + pr check).
  - `guard commit` branch_pr guardrails (tasks.json protection, branch ↔ task id enforcement with exceptions for closure on main).
  - `verify` support for running in a specific checkout (`--cwd`).
- Config:
  - Add `.codex-swarm/swarm.config.json` to enable `workflow_mode=branch_pr`.
- Docs:
  - Update existing workflow docs to use `.codex-swarm/worktrees/` and the normalized branch naming.

## Verification

- `python scripts/agentctl.py task lint`
- `python -m compileall scripts/agentctl.py`
- Manual smoke:
  - `python scripts/agentctl.py branch create T-067 --agent CODER --slug smoke --worktree`
  - `python scripts/agentctl.py pr open T-067 --branch task/T-067/smoke --author CODER`
  - `python scripts/agentctl.py pr check T-067 --branch task/T-067/smoke`
  - `python scripts/agentctl.py integrate T-067 --branch task/T-067/smoke --dry-run`

## Outcome

- `workflow_mode` config is now consolidated to `.codex-swarm/swarm.config.json` and `branch_pr` enforcement is enabled there.
- Worktrees are rooted at `.codex-swarm/worktrees/`, and PR artifacts are tracked under `docs/workflow/prs/T-###/`.
- `tasks.json` updates for closure are now gated to `main`, and handoff notes are captured in `docs/workflow/prs/T-###/review.md` and appended at `finish`.

## Commits

- Planning: `0a08f61` (main)
- Implementation: `91b3760` (main)
- Closure: (this commit) marks `T-067` DONE and syncs docs
